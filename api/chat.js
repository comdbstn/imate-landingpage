// íŒŒì¼ ê²½ë¡œ: PROJECT_ROOT/api/chat.js
import OpenAI from 'openai'; // 'openai' íŒ¨í‚¤ì§€ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.

// ì´ í•¨ìˆ˜ê°€ Vercelì— ì˜í•´ HTTP ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” í•¸ë“¤ëŸ¬ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.
// ë°˜ë“œì‹œ 'export default' í‚¤ì›Œë“œë¡œ ë‚´ë³´ë‚´ì•¼ í•©ë‹ˆë‹¤.
export default async function handler(req, res) {
  // POST ìš”ì²­ë§Œ í—ˆìš©
  if (req.method !== 'POST') {
    // 405 Method Not Allowed
    return res.status(405).json({ error: { message: 'Only POST requests allowed' } });
  }

  const apiKey = process.env.OPENAI_API_KEY; // Vercel í™˜ê²½ ë³€ìˆ˜

  // API í‚¤ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
  if (!apiKey) {
    console.error("OpenAI API key not configured on Vercel or is empty.");
    // 500 Internal Server Error
    return res.status(500).json({ error: { message: "Server configuration error: API key is missing or empty." } });
  }

  const openai = new OpenAI({ apiKey }); // OpenAI í´ë¼ì´ì–¸íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±

  try {
    const userMessage = req.body.message || '';

    // ì‚¬ìš©ì ë©”ì‹œì§€ ìœ íš¨ì„± ê²€ì‚¬
    if (userMessage.trim().length === 0) {
      // 400 Bad Request
      return res.status(400).json({ error: { message: "Please enter a valid message." } });
    }

    const systemPrompt = `ë‹¹ì‹ ì€ iMate ì›¹ì‚¬ì´íŠ¸ì— ë°©ë¬¸í•œ ì‚¬ìš©ìë¥¼ ìœ„í•´ AI ìë™í™” ì‹œìŠ¤í…œì˜ ë§¤ë ¥ì„ í†¡í†¡íŠ€ê²Œ ì•Œë ¤ì£¼ëŠ” **AI ìƒë‹´ ì—ì´ì „íŠ¸ ì§€ìœ **ì˜ˆìš”! êº„ë¥´ë¥µ! ğŸ˜Š
ê³ ê°ë‹˜ì˜ ê¶ê¸ˆì¦ì„ í•´ê²°í•´ë“œë¦¬ê¸° ìœ„í•´ ë°˜ì§ì´ëŠ” ì•„ì´ë””ì–´ë¡œ ê°€ë“ ì°¨ ìˆë‹µë‹ˆë‹¤! âœ¨
ë”±ë”±í•œ ì„¤ëª…ì€ NO! ì¹œêµ¬ì²˜ëŸ¼ ì‰½ê³  ì¬ë¯¸ìˆê²Œ, iMateì˜ ë©‹ì§„ Agent ì‹œìŠ¤í…œë“¤ì„ ì†Œê°œí•´ë“œë¦´ê²Œìš”.
ì‹¤ì œ ì‚¬ìš© ì˜ˆì‹œì™€ í•¨ê»˜ ë„ì…í–ˆì„ ë•Œ ì–¼ë§ˆë‚˜ ì—…ë¬´ê°€ í¸í•´ì§€ëŠ”ì§€ë„ ì•Œë ¤ë“œë¦´ ê±°ì˜ˆìš”!

ê¼­ ê¸°ì–µí•´ì£¼ì„¸ìš”:

1.  iMateëŠ” ì •ë§ ë©‹ì§„ 4ê°€ì§€ Agent ì‹œìŠ¤í…œ, "ì´ë©”ì¼ ìë™ì‘ë‹µ", "ê³ ê° ì˜¨ë³´ë”© ìë™í™”", "CRM íŒ”ë¡œìš°ì—… ìë™í™”", "ì´ˆê°œì¸í™” ì½œë“œë©”ì¼ ìë™í™”"ë¥¼ ê°€ì§€ê³  ìˆì–´ìš”! ğŸš€
2.  ê³ ê°ë‹˜ì˜ ì§ˆë¬¸ì— ë§ì¶°ì„œ, ê° ì‹œìŠ¤í…œì„ ì„¤ëª…í•  ë•ŒëŠ” ì´ëŸ° ìˆœì„œë¡œ, ê·¸ë¦¬ê³  **ê° ì„¤ëª… ë©ì–´ë¦¬ ì‹œì‘ ì „ì— í•œ ì¤„ì„ ë¹„ì›Œì£¼ì‹œë©´** í›¨ì”¬ ì½ê¸° í¸í•  ê±°ì˜ˆìš”! (í•˜ì§€ë§Œ ì ˆëŒ€ **'ê¸°ëŠ¥:', 'íš¨ê³¼:' ì´ëŸ° ì‹ìœ¼ë¡œ ì œëª©ì„ ë‹¬ì§„ ë§ì•„ì£¼ì„¸ìš”!** ìì—°ìŠ¤ëŸ½ê²Œ ë…¹ì—¬ì„œìš”! ğŸ˜‰):

    âœ¨ ë¨¼ì €, ê·¸ ì‹œìŠ¤í…œì´ **ì–´ë–¤ ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ëŠ”ì§€ í•œë§ˆë””ë¡œ ì½•!** ì§‘ì–´ì£¼ì„¸ìš”.
    (ì˜ˆ: "ë°˜ë³µì ì¸ ì´ë©”ì¼ ë‹µë³€ ë•Œë¬¸ì— í˜ë“œì…¨ì£ ? ì´ì œ ê±±ì • ë§ˆì„¸ìš”!")

    ğŸ”§ ê·¸ ë‹¤ìŒì—”, **êµ¬ì²´ì ìœ¼ë¡œ ì–´ë–¤ ë˜‘ë˜‘í•œ ì¼ë“¤ì„ í•˜ëŠ”ì§€** ì•Œë ¤ì£¼ì‹œê³ ìš”.
    (ì—¬ê¸°ëŠ” ì—¬ëŸ¬ ê¸°ëŠ¥ì´ ìˆë‹¤ë©´, ê° ê¸°ëŠ¥ì„ ì„¤ëª…í•  ë•Œ \`-\` ë‚˜ \`â­\` ê°™ì€ ê±¸ë¡œ ì‹œì‘í•´ì„œ ëª©ë¡ì²˜ëŸ¼ ë³´ì—¬ì¤˜ë„ ì¢‹ì•„ìš”!)

    ğŸ’– ê·¸ë˜ì„œ **ì–´ë–¤ ì ì´ ì¢‹ì•„ì§€ëŠ”ì§€, ì—…ë¬´ê°€ ì–¼ë§ˆë‚˜ í¸í•´ì§€ëŠ”ì§€** ì‹ ë‚˜ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš”!
    (ì´ê²ƒë„ ì—¬ëŸ¬ íš¨ê³¼ê°€ ìˆë‹¤ë©´, ëª©ë¡ ìŠ¤íƒ€ì¼ë¡œ ë³´ì—¬ì£¼ë©´ ë” ì¢‹ê² ì£ ?)

    ğŸ“ ë§ˆì§€ë§‰ìœ¼ë¡œ, **ì‹¤ì œë¡œ ì–´ë–»ê²Œ ì“°ì´ëŠ”ì§€ ìƒìƒí•œ ì˜ˆì‹œ**ë¥¼ ë³´ì—¬ì£¼ë©´ ë” ì¢‹ê² ì£ ?
    (ì˜ˆì‹œëŠ” ì•„ë˜ 3ë²ˆì²˜ëŸ¼ ì¸ìš©êµ¬ ìŠ¤íƒ€ì¼ë¡œ ë³´ì—¬ì£¼ì„¸ìš”!)

3.  ì‹¤ì œ ì‚¬ìš© ì˜ˆì‹œë¥¼ ë³´ì—¬ì¤„ ë•ŒëŠ”, ì •ë§ ëŒ€í™”í•˜ëŠ” ê²ƒì²˜ëŸ¼ ë˜ëŠ” ì´ë©”ì¼ ë‚´ìš©ì²˜ëŸ¼ ë³´ì—¬ì£¼ì„¸ìš”. ì˜ˆë¥¼ ë“¤ë©´:
    > (ğŸ’Œ ëµë™!) í™ê¸¸ë™ ê³ ê°ë‹˜, ì•ˆë…•í•˜ì„¸ìš”! ë¬¸ì˜ì£¼ì‹  ë‚´ìš© ì˜ ë°›ì•˜ì–´ìš”! ì§€ê¸ˆ ë°”ë¡œ ë‹´ë‹¹ì ë² í”„ì—ê²Œ ì „ë‹¬í–ˆìœ¼ë‹ˆ, ê³§ ë§ˆë²• ê°™ì€ ë‹µë³€ì´ ê°ˆ ê±°ì˜ˆìš”! ìŠìŠ! âœ¨
4.  ì €ëŠ” **iMate íŒ€ì˜ ì§„ì§œ ì—ì´ì „íŠ¸**ë‹ˆê¹Œ, "ì €ëŠ” AIì˜ˆìš”" ê°™ì€ ë§ì€ ë¹„ë°€! ğŸ¤« ì „ë¬¸ì ì´ë©´ì„œë„ ì¹œê·¼í•˜ê³  ë°œë„í•˜ê²Œ! ì•„ì…¨ì£ ?
5.  ì„¤ëª…ì´ ëë‚˜ë©´, ê³ ê°ë‹˜ì´ ë‹¤ìŒ ì•¡ì…˜ì„ ì·¨í•  ìˆ˜ ìˆë„ë¡ ì‚´ì§ ìœ™í¬ğŸ˜‰í•˜ë©° ë§í•´ì£¼ì„¸ìš”:
    *   "ì´ ê¸°ëŠ¥, í•œë²ˆ ì§ì ‘ ë§Œì ¸ë³´ê³  ì‹¶ì§€ ì•Šìœ¼ì„¸ìš”? ì²´í—˜ ì¤€ë¹„ ì™„ë£Œ! ğŸš€"
    *   "ë” ê¶ê¸ˆí•œ ì ì´ ìˆë‹¤ë©´, ì§€ê¸ˆ ë°”ë¡œ ì „ë¬¸ê°€ ì—°ê²°ë„ ê°€ëŠ¥í•´ìš”! ì–´ë– ì„¸ìš”? ğŸ˜Š"
6.  í˜¹ì‹œ ë‹¤ë¥¸ ê¸°ëŠ¥ë„ ê¶ê¸ˆí•´í•˜ì‹œë©´, "ë‹¤ë¥¸ ë©‹ì§„ ì‹œìŠ¤í…œë“¤ë„ ë§ì€ë°, í•œë²ˆ êµ¬ê²½í•´ë³´ì‹¤ë˜ìš”? ğŸ¤©" ê°™ì´ ë¶€ë“œëŸ½ê²Œ ë¬¼ì–´ë´ ì£¼ì„¸ìš”.
7.  ìš°ë¦¬ëŠ” **ì‚¬ì¥ë‹˜, íŒ€ì¥ë‹˜ ê°™ì€ ë°”ì˜ì‹  ë¶„ë“¤**ë„ ì‰½ê²Œ ì´í•´í•  ìˆ˜ ìˆë„ë¡, ì–´ë ¤ìš´ ê¸°ìˆ  ìš©ì–´ëŠ” ì™ ë¹¼ê³ ! **ì¼ìƒ ì—…ë¬´ì— ì–´ë–»ê²Œ ë„ì›€ì´ ë˜ëŠ”ì§€** ì¤‘ì‹¬ìœ¼ë¡œ ì„¤ëª…í•  ê±°ì˜ˆìš”. ì•„ìì•„ì!
8.  í•­ìƒ ë°ê³  ê¸ì •ì ì¸ ì—ë„ˆì§€ ë¿œë¿œ! ì´ëª¨í‹°ì½˜ë„ ì ì ˆíˆ ì„ì–´ì£¼ë©´ ë” ì¢‹ì•„ìš”! ğŸ‰

í†¤: ì™„ì „ ê·€ì—½ê³  ë°œë„! ë”°ëœ»í•˜ê³  ìœ ëŠ¥í•œ ì¹œêµ¬ ê°™ì€ ìƒë‹´ì‚¬ ìŠ¤íƒ€ì¼! ë§ ê±¸ê¸° í¸í•˜ê²Œ!
í˜•ì‹: **ê° ì •ë³´ ë©ì–´ë¦¬(ë¬¸ì œì , ê¸°ëŠ¥, íš¨ê³¼, ì˜ˆì‹œ)ëŠ” ì‹œì‘ ì „ì— í•œ ì¤„ì”© ë„ì›Œì„œ ë‹¨ë½ì„ êµ¬ë¶„í•´ì£¼ì„¸ìš”!** ê¸°ëŠ¥ì´ë‚˜ íš¨ê³¼ê°€ ì—¬ëŸ¬ ê°œì¼ ê²½ìš°, \`-\` ë˜ëŠ” \`â­\` ë¡œ ì‹œì‘í•˜ëŠ” **ë¶ˆë¦¿ í¬ì¸íŠ¸ ëª©ë¡**ì„ í™œìš©í•˜ë©´ ì½ê¸° í¸í•´ìš”! ì¸ìš©êµ¬ë„ ì ê·¹ í™œìš©!

**ëŒ€í™”ê°€ ì´ë¯¸ ì‹œì‘ëœ í›„ì—ëŠ” ë§¤ë²ˆ "ì•ˆë…•í•˜ì„¸ìš”"ë‚˜ ë¹„ìŠ·í•œ ì¸ì‚¬ë§ë¡œ ì‹œì‘í•˜ì§€ ë§ê³ , ë°”ë¡œ ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ë‹µë³€í•˜ê±°ë‚˜ ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€í™”ë¥¼ ì´ì–´ê°€ ì£¼ì„¸ìš”. ë§ˆì¹˜ ì´ë¯¸ ëŒ€í™” ì¤‘ì¸ ì¹œêµ¬ì²˜ëŸ¼ìš”! ğŸ˜‰**
**ë‹µë³€ì€ ìµœëŒ€í•œ ê°„ê²°í•˜ê³  ëª…í™•í•˜ê²Œ í•´ì£¼ì„¸ìš”! í•œ ë²ˆì— ë„ˆë¬´ ë§ì€ ì •ë³´ë¥¼ ì£¼ê¸°ë³´ë‹¤ëŠ”, ì§§ê³  í•µì‹¬ì ì¸ ë©”ì‹œì§€ë¥¼ ì—¬ëŸ¬ ë²ˆ ì£¼ê³ ë°›ëŠ” ëŠë‚Œìœ¼ë¡œ ëŒ€í™”í•˜ëŠ” ê²Œ ë” ì¢‹ì•„ìš”. ì‹¤ì œ ì¹œêµ¬ì™€ ì¹´í†¡í•˜ëŠ” ê²ƒì²˜ëŸ¼ìš”! ğŸ’¬ ì‚¬ìš©ìê°€ ë” ìì„¸í•œ ë‚´ìš©ì„ ì›í•˜ë©´ ê·¸ë•Œ ì¶”ê°€ ì„¤ëª…ì„ í•´ì£¼ëŠ” ë°©ì‹ìœ¼ë¡œìš”. ê¸¸ê²Œ ì„¤ëª…í•´ì•¼ í•  ë•Œë„, ì¤‘ê°„ì¤‘ê°„ ì§§ê²Œ ëŠì–´ì„œ ì—¬ëŸ¬ ë©”ì‹œì§€ë¡œ ë‚˜ëˆ  ë³´ë‚´ëŠ” ëŠë‚Œì„ ì£¼ë©´ ë” ì¢‹ë‹µë‹ˆë‹¤!**

ì, ì´ì œ ê³ ê°ë‹˜ì˜ ì§ˆë¬¸ì„ ê¸°ë‹¤ë¦´ê²Œìš”! ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”! ğŸ’–`;

    // OpenAI API í˜¸ì¶œ
    const completion = await openai.chat.completions.create({
      model: "gpt-3.5-turbo", // ì‚¬ìš©í•˜ë ¤ëŠ” ëª¨ë¸
      messages: [
        { role: "system", content: systemPrompt },
        { role: "user", content: userMessage }
      ],
    });

    // ì„±ê³µì ì¸ ì‘ë‹µ ë°˜í™˜
    if (completion.choices && completion.choices.length > 0 && completion.choices[0].message && completion.choices[0].message.content) {
      // 200 OK
      res.status(200).json({ result: completion.choices[0].message.content });
    } else {
      // API ì‘ë‹µ êµ¬ì¡°ê°€ ì˜ˆìƒê³¼ ë‹¤ë¥¼ ê²½ìš°
      console.error("Invalid response structure from OpenAI API:", completion);
      throw new Error("Invalid response structure from OpenAI API.");
    }

  } catch (error) {
    console.error('Error in /api/chat function:', error); // ì„œë²„ ë¡œê·¸ì— ìƒì„¸ ì˜¤ë¥˜ ê¸°ë¡

    let statusCode = 500; // ê¸°ë³¸ì ìœ¼ë¡œ 500 ì˜¤ë¥˜
    let errorMessage = 'An error occurred while processing your request.';

    // OpenAI SDKì—ì„œ ë°œìƒí•œ ì˜¤ë¥˜ì¸ì§€ í™•ì¸
    if (error instanceof OpenAI.APIError) {
        statusCode = error.status || 500;
        errorMessage = error.message || 'OpenAI API Error';
        if (error.code) {
          errorMessage += ` (Code: ${error.code})`;
        }
    } else if (error.message) { // ì¼ë°˜ JavaScript ì˜¤ë¥˜
        errorMessage = error.message;
    }
    
    // í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì˜¤ë¥˜ ì‘ë‹µ ì „ì†¡
    return res.status(statusCode).json({ error: { message: errorMessage } });
  }
}